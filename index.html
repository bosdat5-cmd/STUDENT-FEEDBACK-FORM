<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Feedback Form</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9fafb; padding: 20px; }
    .form-page { display: none; }
    .form-section { margin-bottom: 15px; }
    .form-section label { display: block; font-weight: bold; margin-bottom: 5px; }
    input, select { width: 100%; padding: 8px; margin-bottom: 10px; }
    button { background: #2563eb; color: #fff; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
  </style>
</head>
<body>

<div class="max-w-3xl mx-auto p-6 bg-white shadow rounded">
  <h2 class="text-2xl font-bold mb-4">Student Feedback Form</h2>

  <!-- Page 1 -->
  <div class="form-page" id="page1">
    <div class="form-section">
      <label>Student Name</label>
      <input type="text" id="studentName">
    </div>
    <div class="form-section">
      <label>Registration Number</label>
      <input type="text" id="regNumber" placeholder="e.g. CRO1234567">
    </div>
    <div class="form-section">
      <label>Email</label>
      <input type="email" id="email">
    </div>
    <div class="form-section">
      <label>Mobile Number</label>
      <input type="text" id="mobile" maxlength="10">
    </div>
    <button onclick="validatePage1()">Next →</button>
  </div>

  <!-- Page 2 -->
  <div class="form-page" id="page2">
    <div class="form-section">
      <label>Select Faculty</label>
      <select id="facultySelect"></select>
    </div>
    <button onclick="validatePage2()">Next →</button>
  </div>

  <!-- Page 3 -->
  <div class="form-page" id="page3">
    <div class="form-section">
      <label>Batch ID</label>
      <input type="text" id="batchId">
    </div>
    <div class="form-section">
      <label>Quiz Marks</label>
      <input type="number" id="quizMarks">
    </div>

    <div id="questionsContainer"></div>

    <div class="form-section">
      <label>Weighted Score</label>
      <span id="weightageScore">0</span>
    </div>
    <div class="form-section">
      <label>Grade</label>
      <span id="grade">-</span>
    </div>

    <button id="submitBtn" onclick="validateFeedback()">Submit</button>
  </div>
</div>

<script>
/* ======= Cleaned JS ======= */

const faculties = ["Sandeep Agarwal","Bhanu Dhir","Shekhar Sharma","Anju Gupta","Preeti Goel","Rohit Agarwal","Sunita Rathore"];
let completedFaculties = [];
const questions = [
  "Attendance & Punctuality","Professional Dress Code","Discipline & Conduct","Active Participation",
  "Group Activities & Teamwork","Presentation - Content","Presentation - Delivery","Communication Skills",
  "Analytical Thinking","Creativity & Innovation","Professional Ethics Awareness","Emotional Intelligence","Overall Engagement"
];

let currentPage = 1;

function showPage(n) {
  currentPage = n;
  document.querySelectorAll(".form-page").forEach(p => p.style.display = "none");
  document.getElementById("page"+n).style.display = "block";
  if(n===2) loadFaculties();
  if(n===3) loadQuestions();
}

function validatePage1(){
  const studentName = document.getElementById("studentName").value.trim();
  const regNumber = document.getElementById("regNumber").value.trim();
  const email = document.getElementById("email").value.trim();
  const mobile = document.getElementById("mobile").value.trim();

  if(!studentName || !regNumber || !email || !mobile){
    alert("⚠️ Please fill all fields");
    return;
  }

  const regPattern = /^(CRO|NRO|FRO|SRO|ERO|WRO)\d{7}$/i;
  if(!regPattern.test(regNumber)){
    alert("⚠️ Invalid Registration Number format!");
    return;
  }

  if(!/^[6-9]\d{9}$/.test(mobile)){
    alert("⚠️ Invalid mobile number!");
    return;
  }

  if(!email.includes("@") || !email.includes(".")){
    alert("⚠️ Invalid email address!");
    return;
  }

  showPage(2);  
}

function loadFaculties() {
  const sel = document.getElementById("facultySelect");
  sel.innerHTML = `<option value="">-- Select Faculty --</option>`;
  faculties.forEach(f => {
    if(!completedFaculties.includes(f)){
      const opt = document.createElement("option");
      opt.value = f;
      opt.textContent = f;
      sel.appendChild(opt);
    }
  });
}

function validatePage2() {
  const faculty = document.getElementById("facultySelect").value;
  if(!faculty){ 
    alert("⚠️ Please select a faculty!"); 
    return; 
  }
  showPage(3);
}

function loadQuestions() {
  const container = document.getElementById("questionsContainer");
  container.innerHTML = "";
  questions.forEach((q,i)=>{
    const div = document.createElement("div");
    div.className="form-section";
    div.innerHTML = `
      <label>${q}</label>
      <select id="q${i}" onchange="updateScore()">
        <option value="">-- Select --</option>
        <option value="1">1 - Poor</option>
        <option value="2">2 - Fair</option>
        <option value="3">3 - Good</option>
        <option value="4">4 - Very Good</option>
        <option value="5">5 - Excellent</option>
      </select>
    `;
    container.appendChild(div);
  });
}

function updateScore() {
  let total=0, count=0;
  questions.forEach((q,i)=>{
    const v = Number(document.getElementById("q"+i).value);
    if(v){ total+=v; count++; }
  });
  const avg = count ? (total/count).toFixed(2) : 0;
  document.getElementById("weightageScore").innerText = avg;
  let grade="-";
  if(avg>=4.5) grade="A+";
  else if(avg>=4.0) grade="A";
  else if(avg>=3.5) grade="B+";
  else if(avg>=3.0) grade="B";
  else grade="C";
  document.getElementById("grade").innerText=grade;
}

async function validateFeedback() {
  const submitBtn = document.getElementById("submitBtn"); 
  const batchId = document.getElementById("batchId").value.trim();
  const quizMarks = document.getElementById("quizMarks").value.trim();

  if (!batchId || quizMarks === "") {
    alert("⚠️ Fill Batch ID & Quiz Marks");
    return;
  }

  const unanswered = [];
  questions.forEach((q, i) => {
    if (!document.getElementById("q" + i)?.value) unanswered.push(i + 1);
  });
  if (unanswered.length > 0) {
    alert("⚠️ Answer all questions. Missing Qs: " + unanswered.join(","));
    return;
  }

  const faculty = document.getElementById("facultySelect").value;
  const payload = {
    timestamp: new Date().toISOString(),
    studentName: document.getElementById("studentName").value.trim(),
    regNumber: document.getElementById("regNumber").value.trim(),
    email: document.getElementById("email").value.trim(),
    mobile: document.getElementById("mobile").value.trim(),
    faculty,
    batchId,
    quizMarks: Number(quizMarks),
    weightage: parseFloat(document.getElementById("weightageScore").innerText),
    grade: document.getElementById("grade").innerText,
    answers: questions.map((q, i) => document.getElementById("q" + i).value)
  };

  try {
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerText = "Submitting... ⏳";
    }

    const response = await fetch(
      "https://script.google.com/macros/s/AKfycbwFoCXaitd0DO6obxsE8s4PSEMwD_9c6Zc2c7ol-y55LoOjpH2BOtk_qMdUlLcNE9np/exec",
      { method: "POST", body: JSON.stringify(payload) }
    );

    const res = await response.json();

    if (res.status === "success") {
      completedFaculties.push(faculty);
      alert("✅ Feedback submitted for " + faculty);
      resetFeedbackForm();

      if (completedFaculties.length < faculties.length) {
        loadFaculties();
        showPage(2);
      } else {
        document.querySelectorAll(".form-page").forEach(p => p.style.display = "none");
        const container = document.querySelector(".max-w-3xl");
        const done = document.createElement("div");
        done.innerHTML = `
          <h2 class="text-2xl font-bold mb-4">Thank you!</h2>
          <p>All feedback submitted.</p>
        `;
        container.appendChild(done);
      }
    } else {
      alert("⚠️ Error saving data. Try again.");
    }
  } catch (err) {
    console.error(err);
    alert("⚠️ Connection error. Data not saved.");
  } finally {
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit";
    }
  }
}

function resetFeedbackForm() {
  document.getElementById("batchId").value="";
  document.getElementById("quizMarks").value="";
  questions.forEach((q,i)=>document.getElementById("q"+i).value="");
  document.getElementById("weightageScore").innerText="0";
  document.getElementById("grade").innerText="-";
}

/* Default page */
showPage(1);
</script>
</body>
</html>
